name: Sync Garmin Data

on:
  workflow_dispatch:           # 手动触发
  repository_dispatch:         # Webhook 触发
    types: [sync-garmin]
  schedule:
    - cron: '0 0 * * *'        # 每日 UTC 00:00

env:
  NODE_VERSION: '22'

# 必须显式声明，否则 GITHUB_TOKEN 默认只有读权限，无法 push
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Restore database cache
        uses: actions/cache@v4
        with:
          path: app/data/activities.db
          key: garmin-db-${{ github.sha }}
          restore-keys: |
            garmin-db-

      - name: Sync Garmin data
        env:
          GARMIN_SECRET_STRING: ${{ secrets.GARMIN_SECRET_STRING }}
          MAX_HR: ${{ secrets.MAX_HR }}
          RESTING_HR: ${{ secrets.RESTING_HR }}
        run: |
          node scripts/sync-garmin.js

      - name: Update stats cache (hr_zone, vdot_trend)
        env:
          MAX_HR: ${{ secrets.MAX_HR }}
          RESTING_HR: ${{ secrets.RESTING_HR }}
        run: |
          node scripts/preprocess-stats-cache.js --mode full --clear

      - name: Show sync results
        if: always()
        run: |
          if [ -f app/data/activities.db ]; then
            echo "Database size: $(du -h app/data/activities.db | cut -f1)"
            echo "Activities count: $(sqlite3 app/data/activities.db 'SELECT COUNT(*) FROM activities;' 2>/dev/null || echo 'N/A')"
          fi

      - name: Commit and push
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add app/data/activities.db
          git diff --staged --quiet || git commit -m "chore: update garmin data $(date +%Y-%m-%d)"
          git push
